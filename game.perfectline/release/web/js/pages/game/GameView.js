var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var e in s)s.hasOwnProperty(e)&&(t[e]=s[e])};return function(s,e){function i(){this.constructor=s}t(s,e),s.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),GameView=function(t){function s(){var s=null!==t&&t.apply(this,arguments)||this;return s.ui=new ui.pages.GamePageUI,s._items=[],s._autoLast=!1,s._reviveTimes=0,s._awsomeTime=0,s._turnable=!0,s._gift={},s._giftList=[],s._rewards={},s.RoadWidth=160,s.PickInfo=[15,18],s.curX=Laya.stage.width/2,s.curY=Laya.stage.height/2,s.delX=0,s.delY=0,s.speedX=0,s.speedY=0,s.dir=1,s.deviation=80,s.targetX=s.curX,s.targetY=s.curY,s}return __extends(s,t),s.prototype.show=function(){for(var s=[],e=0;e<arguments.length;e++)s[e]=arguments[e];t.prototype.show.call(this),this.params=s[0],this.ui.btnPause.visible=!1,this.ui.backBtn.visible=!1,XFacade.instance.showModule(GameLoading,this.params),trace("this.params:::::::::::",this.params),this.ui.bg.skin=AppConfig.urlRoot+"res/map/"+this.params.bg+".jpg",AppConfig.platfrom==AppConfig.Plat4399&&(this.PickInfo[0]=45,this.PickInfo[1]=54),this._giftList.length=0;for(var i=2,a=1,h=0;h<150;h++){var n=Math.random();n>.62?this._giftList.push(ItemVo.GOLD):n>.6?i>0?(i--,this._giftList.push(ItemVo.DIAMOND)):a>0?(a--,this._giftList.push(ItemVo.KEY)):this._giftList.push(ItemVo.GOLD):this._giftList.push(ItemVo.GOLD)}var r=Math.max(Laya.stage.width/AppConfig.AppWidth,Laya.stage.height/AppConfig.AppHeight);this.ui.bg.scale(r,r),this.ui.x=(this.ui.bg.width-AppConfig.AppWidth)/2,"showall"===Laya.stage.scaleMode&&(AppConfig.ScaleRate=Laya.Browser.clientHeight/AppConfig.AppHeight)},s.prototype.close=function(){this.onDestroy(),t.prototype.close.call(this)},s.prototype.onBtnClick=function(t){switch(t.currentTarget){case this.ui.btnPause:this.pause();break;case this.ui.backBtn:this.close()}},s.prototype.onGameEvent=function(t,s){switch(void 0===s&&(s=null),t){case GameEvent.BACK:this.stop(),this.close();break;case GameEvent.RESTART:this.restart();break;case GameEvent.SELECTED:this.ui.selectBox.visible=!0,this.ui.btnPause.visible=!1,this.ui.backBtn.visible=!1,this.initMap(),this.on(Laya.Event.CLICK,this,this.onStart);break;case GameEvent.REVIVE:this.revive()}},s.prototype.onFocus=function(){this.soundChannel&&!this.soundChannel.isStopped||this.close()},s.prototype.onStart=function(t){trace("onStart======================>>>",this.ui.selectBox.visible),!this.ui.selectBox.visible&&(this.off(Laya.Event.CLICK,this,this.onStart),this.soundChannel)||(trace("onStart======================>>>1"),t.stopPropagation(),User.instace.power>0?(User.instace.power-=1,this.ui.selectBox.visible=!1,this.startWithCfg(),Laya.stage.off(Laya.Event.CLICK,this,this.onStart)):XFacade.instance.showModule(PopAddPower))},s.prototype.pause=function(){if(this.soundChannel){Star.sleep();try{this.soundChannel.pause()}catch(t){}Laya.timer.clear(this,this.update),Laya.timer.clear(this,this.update2),Laya.stage.off(Laya.Event.CLICK,this,this.onC),XFacade.instance.showModule(PopGamePause,Laya.Handler.create(this,this.toResume),Laya.Handler.create(this,this.restart)),Laya.timer.clear(this,this.refreshState)}},s.prototype.toResume=function(){DBGame.countdown(3,Laya.Handler.create(this,this.resume))},s.prototype.restart=function(){User.instace.power>0?(User.instace.power-=1,User.instace.save(),this.stop(),this.initMap(!1),this.startWithCfg()):XFacade.instance.showModule(PopAddPower)},s.prototype.revive=function(){var t=this;if(User.instace.power>0){User.instace.power-=1,User.instace.save(),this._reviveTimes--;var s=this.getStdPoint(this._startTime);this.targetX=s.x,this.targetY=s.y,this.ball.pos(s.x,s.y),this.ball.reset(),this.dir=1;var e=this.getStdNode(this._startTime);this.speedX=e.sx,DBGame.countdown(3,Handler.create(null,function(){t.soundChannel.play(),t._awsomeTime=3,t.showAwesome()}))}else XFacade.instance.showModule(PopAddPower)},s.prototype.showAwesome=function(){this._awsomeTime>0&&(this._turnable=!1,this.ball.flash(),Laya.timer.loop(100,this,this.refreshState))},s.prototype.refreshState=function(){var t=this;this._awsomeTime-=.1,this._awsomeTime<=0&&(this.ball.removeFlash(),this.dir=1,this._awsomeTime=0,Laya.timer.clear(this,this.refreshState),Laya.timer.once(1e3,null,function(){t._turnable=!0}))},s.prototype.stop=function(){this.soundChannel&&(this.soundChannel.stop(),Laya.SoundManager.removeChannel(this.soundChannel),this.soundChannel.completeHandler=null),Star.sleep(),Laya.timer.clear(this,this.update),Laya.timer.clear(this,this.update2),Laya.stage.off(Laya.Event.CLICK,this,this.onC),Laya.SoundManager.destroySound(s.mp3)},s.prototype.resume=function(){this.soundChannel&&(this.soundChannel.play(),this.showAwesome())},s.prototype.initMap=function(t){void 0===t&&(t=!0),this._cfg=Laya.loader.getRes(AppConfig.urlRoot+"res/snd/"+this.params.json+".json"),this._rendIndex=1,this._starNum=this._awsomeTime=this._curTime=this._startTime=this._score=0,this._rewards={},this._autoLast=!1,this._gift={},this._reviveTimes=DBGame.ReviveTimes,this._mapArr=[];for(var s=0;s<this._items.length;s++)this._items[s].removeSelf();for(this._items.length=0;this.effContainer.numChildren;)this.effContainer.removeChildAt(0);var e=this._cfg;this._resList=xframe.XUtils.clone(e.items)||[],this._resList.sort(function(t,s){return t.t-s.t}),t&&Star.shine(30,this.starContainer),this.stop(),this.posInfo=xframe.XUtils.clone(e.nodes),this.srcPosInfo=xframe.XUtils.clone(e.nodes);var i=this.srcPosInfo.shift();this.curX=this.targetX=i.x,this.curY=this.targetY=this.offsetY=i.y,this.speedX=i.sx,this.speedY=e.speed,this.rendMap(),this.ball||(this.ball=new Role,this.ball.shadow(4,""),this.pathSp.addChild(this.ball)),this.ball.setSkin(User.instace.curRole,this.speedY),this.ball.reset(),this.ball.pos(this.curX,this.curY),this.map.y=this.pathSp.y=0},s.prototype.rendMap=function(){for(var t in this._gift){(l=this._gift[t]).y-this.targetY>Laya.stage.height&&(delete this._gift[t],l.removeSelf())}var s=this.targetY-this.offsetY;if(!this._mapArr.length||!(this._autoLast||s-this._mapArr[this._mapArr.length-1]>120)){for(var e,i,a=this._cfg,h=a.nodes.length-1;h>=0;h--)if(a.nodes[h].y>s){e=h;break}for(h=e;h>=0&&!(a.nodes[h].y-s>=Laya.stage.height);h--);for(i=Math.max(0,h),s=a.nodes[i].y,this._mapArr.length=0,h=i;h<a.nodes.length&&s-a.nodes[h].y<4096;h++)this._mapArr.push(a.nodes[h].x,a.nodes[h].y);if(this.map.graphics.clear(),0==i&&(this.map.graphics.drawCircle(this._mapArr[0],this._mapArr[1],this.RoadWidth,"#ffffff"),this.map.graphics.drawTexture(Laya.loader.getRes("res/game/start_bg.png"),this._mapArr[0]-200,this._mapArr[1]-200)),this.map.graphics.drawLines(0,0,this._mapArr,"#ffffff",this.RoadWidth*AppConfig.ScaleRate),h>=a.nodes.length&&this.soundChannel.duration){this._autoLast=!0;var n=this.posInfo[this.posInfo.length-1],r=1e3*this.soundChannel.duration;trace("end=========================",this.soundChannel,n,this.soundChannel.duration);var o={x:n.x,y:n.y-(r-n.t)*this.speedY,sx:0,sy:n.sy,t:r};this.posInfo.push(o),this.srcPosInfo.push(o),this.map.graphics.drawLine(n.x,n.y,o.x,o.y,"#ffffff",this.RoadWidth*AppConfig.ScaleRate),this.map.graphics.drawCircle(o.x,o.y,this.RoadWidth,"#ffffff"),this.map.graphics.drawTexture(Laya.loader.getRes("res/game/start_bg.png"),o.x-200,o.y-200)}var p=this._autoLast?3:1;for(h=0==i?2:0;h<this._mapArr.length-p;h++){if(!this._gift[this._mapArr[h]+"_"+this._mapArr[h+1]]&&this._giftList[i+h/2]){var l=new Laya.Image,d=this._giftList[i+h/2];d>0&&(l.skin="res/common/"+d+".png"),this.pathSp.addChildAt(l,0),l.pos(this._mapArr[h]-28,this._mapArr[h+1]-28),l.name=d+"",this._gift[this._mapArr[h]+"_"+this._mapArr[h+1]]=l,this._giftList[i+h/2]=0}"1"==this.params.id&&i<3&&(this._mapArr[h]>this.ui.width/2?this.map.graphics.drawTexture(Laya.loader.getRes("res/game/click.png"),this._mapArr[h]+135,this._mapArr[h+1]-32):this.map.graphics.drawTexture(Laya.loader.getRes("res/game/click.png"),this._mapArr[h]-195,this._mapArr[h+1]-32)),h++}}},s.prototype.startWithCfg=function(){Laya.Browser.onWeiXin?this.start():(this.stop(),this.soundChannel=Laya.SoundManager.playSound(s.mp3,1,Laya.Handler.create(this,this.gemeEnd)),this._curTime=this.soundChannel.position,Laya.timer.frameLoop(1,this,this.update),Laya.stage.on(Laya.Event.CLICK,this,this.onC))},s.prototype.start=function(){var t=this,e=encodeURI(Laya.URL.basePath+s.mp3);this.soundChannel&&this.soundChannel.src!=e&&this.soundChannel.destroy(),this.soundChannel=wx.createInnerAudioContext(),this.soundChannel.src=e,this.soundChannel.play(),this.soundChannel.onPlay(function(){0==t._startTime?t._curTime=t._startTime=Laya.Browser.now():(t._curTime=Laya.Browser.now(),t._startTime=t._curTime-t._startTime),Laya.timer.frameLoop(1,t,t.update2),Laya.stage.on(Laya.Event.CLICK,t,t.onC)}),this.soundChannel.onEnded(function(){t.gemeEnd()}),this.soundChannel.onPause(function(){t._startTime=Laya.Browser.now()-t._startTime}),this.soundChannel.onError(function(){t.close(),User.instace.power+=1,User.instace.save()})},s.prototype.update2=function(){this._rendIndex++;var t=this._rendIndex%5,s=!1,e=Laya.Browser.now()-this._curTime;this._curTime=Laya.Browser.now();var i=this._curTime-this._startTime;if(Star.active(),this._awsomeTime){var a=this.getStdPoint(i);if(this.targetY=a.y,this.targetX=a.x,4==t){var h=this.getTargetPoint(!0,6);h&&(this.speedX=h.sx,this._score+=1)}}else this.targetY=this.offsetY-this.speedY*i,this.targetX+=this.speedX*e*this.dir;if(this.ball.update(),this.ball.x=this.targetX,this.ball.y=this.targetY,this.pathSp.y=this.offsetY-this.targetY,this.map.y=this.pathSp.y,1==t){var n=this.getTargetPoint(!1);this.srcPosInfo.length<=2?this.ui.btnPause.visible=!1:n&&n.y-this.targetY>150&&(s=!0)}else 2==t||(4==t?this.rendMap():0==t?this.rendMapItems(i):3==t&&this.srcPosInfo.length&&this.getStdPoint(i).distance(this.targetX,this.targetY)>106&&(s=!0,trace("End at time::",i,e,this.targetX,this.targetY,this.getStdPoint(i))));s&&(Star.sleep(),this.soundChannel.pause(),Laya.timer.clear(this,this.update),Laya.timer.clear(this,this.update2),Laya.stage.off(Laya.Event.CLICK,this,this.onC),this._starNum>0&&this._reviveTimes?(this._rewards.revive=!0,this.showResult()):this.showResult())},s.prototype.update=function(){this._rendIndex++;var t=this._rendIndex%5,s=!1,e=1e3*(this.soundChannel.position-this._curTime),i=1e3*this.soundChannel.position;if(!(e<0||0==i)){if(e>500)return trace("Update Error：：Time offset is over..",e,this.soundChannel.position,this._curTime),this.stop(),void Laya.timer.once(1e3,this,this.startWithCfg);if(this._curTime=this.soundChannel.position,Star.active(),this._awsomeTime){var a=this.getStdPoint(i);if(this.targetY=a.y,this.targetX=a.x,4==t){var h=this.getTargetPoint();h&&(this._score+=1,this.speedX=h.sx)}}else this.targetY=this.offsetY-this.speedY*i,this.targetX+=this.speedX*e*this.dir;if(this.ball.update(),this.ball.x=this.targetX,this.ball.y=this.targetY,this.pathSp.y=this.offsetY-this.targetY,this.map.y=this.pathSp.y,1==t){var n=this.getTargetPoint(!1);this.srcPosInfo.length<=2?this.ui.btnPause.visible=!1:n&&n.y-this.targetY>150&&(s=!0)}else 2==t||(4==t?this.rendMap():0==t?this.rendMapItems(1e3*this._curTime):3==t&&this.srcPosInfo.length&&this.getStdPoint(i).distance(this.targetX,this.targetY)>106&&(s=!0,trace("End at time::",i,e,this.targetX,this.targetY,this.getStdPoint(i))));s&&(Star.sleep(),this.soundChannel.pause(),Laya.timer.clear(this,this.update),Laya.stage.off(Laya.Event.CLICK,this,this.onC),this._starNum>0&&this._reviveTimes?(this._rewards.revive=!0,this.showResult()):this.showResult())}},s.prototype.onC=function(){this.curX=this.targetX,this.curY=this.targetY;var t=this.getTargetPoint();if(t){this.dir=1,this.speedX=t.sx;var s=Math.abs(t.x-this.ball.x),e=Math.abs(t.y-this.ball.y);if(s<this.PickInfo[0]&&e<this.PickInfo[1]){this.shine(t.x,t.y),this._score+=1;var i=this._gift[t.x+"_"+t.y];i&&(Laya.Tween.to(i,{y:i.y-300,alpha:.1},700,null,Laya.Handler.create(i,i.removeSelf)),delete this._gift[t.x+"_"+t.y],this._rewards[i.name]?this._rewards[i.name]=parseInt(this._rewards[i.name])+1:this._rewards[i.name]=1)}else this._score+=1}else this.srcPosInfo.length&&this._turnable&&(this.dir*=-1)},s.prototype.showResult=function(){this.stop(),this._rewards.music=this.params,this._rewards.score=Math.round(this._score/this._cfg.nodes.length*100),XFacade.instance.showModule(GameResultView,this._rewards)},s.prototype.rendMapItems=function(t){for(e=0;e<this._items.length&&this._items[e].y-this.targetY>Laya.stage.height;e++)this._items[e].removeSelf(),trace(this._items[e].name),this._items.splice(e--,1);for(var s=.35*Laya.stage.height/this.speedY,e=0;e<this._resList.length&&this._resList[e].t<t+s;e++){var i=new Laya.Image;i.pos(this._resList[e].x,this._resList[e].y);var a=AppConfig.urlRoot+"res/map/"+this._resList[e].id+".png";Laya.loader.load(a,Laya.Handler.create(null,function(){i.skin=a,xframe.AniUtil.popIn(i,200)})),i.scaleX=this._resList[e].s,trace("rendMapItems",i.x,i.y,this._resList[e]),i.name=i.x+"_"+i.y,this.pathSp.addChild(i),this._resList.splice(e--,1),this._items.push(i)}},s.prototype.switchSkin=function(t){if(this.ui.bg.skin!=t)if(this.ui.bg.skin){var s=new Laya.Image(this.ui.bg.skin);s.size(Laya.stage.width,Laya.stage.height),this.ui.bg.parent.addChildAt(s,this.ui.bg.parent.getChildIndex(this.ui.bg)),this.ui.bg.skin=t,this.ui.bg.alpha=0,Laya.Tween.to(this.ui.bg,{alpha:1},500,null,Laya.Handler.create(s,s.removeSelf))}else this.ui.bg.skin=t},s.prototype.shine=function(t,s){this._eff2.pos(t,s),this._eff2.alpha=1,this._eff2.scale(.5,.5),this.pathSp.addChildAt(this._eff2,0),Laya.Tween.to(this._eff2,{scaleX:1.2,scaleY:1.2,alpha:0},200,null,Laya.Handler.create(this._eff2,this._eff2.removeSelf))},s.prototype.getTargetPoint=function(t,s){void 0===t&&(t=!0),void 0===s&&(s=-1);var e;if(this.srcPosInfo.length)for(var i=0;i<this.srcPosInfo.length;i++){var a=this.srcPosInfo[i];if(-1==s&&(s=this.deviation),Math.abs(a.y-this.targetY)<=s||a.y>this.targetY){e=a,t&&this.srcPosInfo.shift();break}break}return e},s.prototype.getStdPoint=function(t){this._stdP||(this._stdP=new Laya.Point(this.curX,this.curY));for(var s,e=this.posInfo.length-1;e>=0&&!((s=this.posInfo[e]).t<=t);e--);var i=t-s.t;return this._stdP.x=s.x+s.sx*i,this._stdP.y=s.y-this.speedY*i,this._stdP},s.prototype.getStdNode=function(t){for(var s,e=this.posInfo.length-1;e>=0;e--)if(this.posInfo[e].t<=t){s=this.posInfo[e];break}for(this.srcPosInfo=[],e+=1;e<this.posInfo.length-1;e++)this.srcPosInfo.push(this.posInfo[e]);return s},s.prototype.gemeEnd=function(){trace("gameEnd----------------------------------------------\x3e>"),this._rewards.music=this.params,this._rewards.score=100,XFacade.instance.showModule(GameResultView,this._rewards),this.stop()},s.prototype.onDestroy=function(){for(var t in this._gift){var e=this._gift[t];delete this._gift[t],e.removeSelf()}Laya.loader.clearRes(this.ui.bg.skin),this.ui.bg.skin="",Laya.loader.clearRes(s.mp3),Star.destroy(),this.ball&&this.ball.stop(),Laya.timer.clear(this,this.update),Laya.stage.off(Laya.Event.CLICK,this,this.onC),Laya.stage.off(Laya.Event.CLICK,this,this.resume),this.stop()},s.prototype.createUI=function(){var s=this;t.prototype.createUI.call(this),this.ui.bg.skin="res/map/bj21.jpg",this.starContainer=new Laya.Sprite,this.ui.addChildAt(this.starContainer,this.ui.getChildIndex(this.ui.btnPause)),this.map=new Laya.Sprite,this.ui.addChildAt(this.map,this.ui.getChildIndex(this.ui.btnPause)),this.pathSp=new Laya.Sprite,this.ui.addChildAt(this.pathSp,this.ui.getChildIndex(this.ui.btnPause)),this.effContainer=new Laya.Sprite,this.ui.addChild(this.effContainer),this._eff2=new Laya.Image("res/game/light.png"),this._eff2.anchorX=this._eff2.anchorY=.5,this.scrollRect=new Laya.Rectangle(0,0,Laya.stage.width,Laya.stage.height),wx.onHide(function(){s.soundChannel&&!s.soundChannel.paused&&s.pause()})},s.prototype.initEvent=function(){XEvent.instance.on(GameEvent.BACK,this,this.onGameEvent,[GameEvent.BACK]),XEvent.instance.on(GameEvent.RESTART,this,this.onGameEvent,[GameEvent.RESTART]),XEvent.instance.on(GameEvent.SELECTED,this,this.onGameEvent,[GameEvent.SELECTED]),XEvent.instance.on(GameEvent.REVIVE,this,this.onGameEvent,[GameEvent.REVIVE]),this.ui.btnPause.on(Laya.Event.CLICK,this,this.onBtnClick),this.ui.backBtn.on(Laya.Event.CLICK,this,this.onBtnClick),Laya.stage.on(Laya.Event.FOCUS,this,this.onFocus)},s.prototype.removeEvent=function(){XEvent.instance.off(GameEvent.BACK,this,this.onGameEvent),XEvent.instance.off(GameEvent.RESTART,this,this.onGameEvent),XEvent.instance.off(GameEvent.SELECTED,this,this.onGameEvent),XEvent.instance.off(GameEvent.REVIVE,this,this.onGameEvent),this.ui.btnPause.off(Laya.Event.CLICK,this,this.onBtnClick),this.ui.backBtn.off(Laya.Event.CLICK,this,this.onBtnClick),Laya.stage.off(Laya.Event.CLICK,this,this.onStart),Laya.stage.off(Laya.Event.FOCUS,this,this.onFocus)},s}(xframe.XWindow),GameEvent=function(){function t(){}return t.BACK="back",t.RESTART="restart",t.SELECTED="selected",t.REVIVE="revive",t.HOMECHAPTER="homechapter",t}();